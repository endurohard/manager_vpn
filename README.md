# VPN Manager Bot

Telegram бот для управления X-UI VPN панелью с системой ролей (Администратор/Менеджеры).

## Возможности

### Для менеджеров:
- Создание VLESS ключей с автоматической настройкой
- Генерация или ввод номера телефона клиента
- Выбор срока действия ключа (Месяц, 3 месяца, 6 месяцев, Год)
- Автоматическая замена IP на домен в ключе
- Лимит 2 IP адреса на ключ
- Просмотр личной статистики

### Для администратора:
- Все возможности менеджера
- Добавление/удаление менеджеров по Telegram ID
- Просмотр списка всех менеджеров
- Общая статистика по всем менеджерам
- История создания ключей каждым менеджером

## Установка

### 1. Клонирование репозитория
```bash
cd /root/manager_vpn
```

### 2. Создание виртуального окружения
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 4. Настройка конфигурации

Скопируйте `.env.example` в `.env`:
```bash
cp .env.example .env
```

Отредактируйте `.env` файл:
```bash
nano .env
```

Заполните все необходимые параметры:
- `BOT_TOKEN` - токен вашего Telegram бота (получите у @BotFather)
- `ADMIN_ID` - ваш Telegram ID (узнайте у @userinfobot)
- `XUI_HOST` - URL вашей X-UI панели (например, http://localhost:54321)
- `XUI_USERNAME` - имя пользователя X-UI панели
- `XUI_PASSWORD` - пароль X-UI панели
- `INBOUND_ID` - ID inbound для создания ключей (по умолчанию 12)
- `DOMAIN` - ваш домен для подключения (например, raphaeilvpn.ru)

### 5. Запуск бота

```bash
python3 main.py
```

Для запуска в фоновом режиме используйте screen или tmux:

#### Через screen:
```bash
screen -S vpn_bot
python3 main.py
# Нажмите Ctrl+A, затем D для отключения
# screen -r vpn_bot для возврата
```

#### Через systemd (рекомендуется):
Создайте файл `/etc/systemd/system/vpn-bot.service`:
```ini
[Unit]
Description=VPN Manager Bot
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/manager_vpn
Environment="PATH=/root/manager_vpn/venv/bin"
ExecStart=/root/manager_vpn/venv/bin/python3 /root/manager_vpn/main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

Затем:
```bash
systemctl daemon-reload
systemctl enable vpn-bot
systemctl start vpn-bot
systemctl status vpn-bot
```

## Использование

### Первый запуск (для администратора):

1. Запустите бота командой `/start`
2. Вы увидите главное меню с дополнительной кнопкой "Панель администратора"

### Добавление менеджеров:

1. Откройте "Панель администратора"
2. Нажмите "Добавить менеджера"
3. Отправьте Telegram ID нового менеджера
4. Менеджер сможет использовать бота

### Создание ключа:

1. Нажмите "Создать ключ"
2. Введите номер телефона клиента или нажмите "Сгенерировать номер"
3. Выберите срок действия ключа
4. Подтвердите создание
5. Скопируйте готовый VLESS ключ и отправьте клиенту

### Просмотр статистики:

#### Личная статистика:
- Нажмите "Моя статистика"
- Увидите количество созданных ключей и последние 5 ключей

#### Общая статистика (только для администратора):
- Откройте "Панель администратора"
- Нажмите "Общая статистика"
- Увидите статистику по всем менеджерам

## Структура проекта

```
manager_vpn/
├── bot/
│   ├── __init__.py
│   ├── config.py              # Конфигурация бота
│   ├── api/
│   │   ├── __init__.py
│   │   └── xui_client.py      # Клиент для работы с X-UI API
│   ├── database/
│   │   ├── __init__.py
│   │   └── db_manager.py      # Управление базой данных
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── common.py          # Общие обработчики
│   │   ├── manager.py         # Обработчики для менеджеров
│   │   └── admin.py           # Обработчики для администратора
│   └── utils/
│       ├── __init__.py
│       ├── keyboards.py       # Клавиатуры бота
│       └── validators.py      # Валидаторы данных
├── main.py                    # Главный файл запуска
├── requirements.txt           # Зависимости
├── .env.example              # Пример конфигурации
├── .gitignore
└── README.md
```

## Технологии

- Python 3.8+
- aiogram 3.x - асинхронный фреймворк для Telegram ботов
- aiohttp - асинхронные HTTP запросы
- aiosqlite - асинхронная работа с SQLite
- python-dotenv - управление переменными окружения

## Безопасность

- Все данные о менеджерах и ключах хранятся в локальной SQLite базе данных
- Доступ к боту только у авторизованных пользователей
- Токен бота и настройки X-UI хранятся в `.env` файле (не попадает в git)

## Лицензия

MIT License

## Поддержка

При возникновении проблем:
1. Проверьте логи в файле `bot.log`
2. Убедитесь, что X-UI панель доступна
3. Проверьте правильность настроек в `.env` файле
4. Проверьте, что inbound с указанным ID существует в X-UI панели
