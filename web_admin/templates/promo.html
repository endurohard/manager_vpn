{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <h2>–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
    <button class="btn btn-primary" onclick="openPromoModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<table class="table">
    <thead>
        <tr>
            <th>–ö–æ–¥</th>
            <th>–°–∫–∏–¥–∫–∞</th>
            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for promo in promos %}
        <tr>
            <td><code>{{ promo.code }}</code></td>
            <td>
                {% if promo.discount_type == 'percent' %}
                {{ promo.discount_value }}%
                {% elif promo.discount_type == 'fixed' %}
                {{ promo.discount_value }}‚ÇΩ
                {% elif promo.discount_type == 'days' %}
                +{{ promo.discount_value }} –¥–Ω.
                {% endif %}
            </td>
            <td>
                {{ promo.uses_count or 0 }}{% if promo.max_uses > 0 %}/{{ promo.max_uses }}{% endif %}
            </td>
            <td>
                {% if promo.is_active %}
                <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                {% else %}
                <span class="badge badge-secondary">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                {% endif %}
            </td>
            <td>{{ promo.valid_until or '–ë–µ—Å—Å—Ä–æ—á–Ω–æ' }}</td>
            <td>
                <button class="btn btn-sm btn-info"
                    onclick="openPromoModal({{ promo.id }}, '{{ promo.code }}', '{{ promo.discount_type }}', {{ promo.discount_value }}, {{ promo.max_uses }}, {{ promo.is_active }})">
                    ‚úèÔ∏è
                </button>
                <button class="btn btn-sm btn-warning" onclick="togglePromo({{ promo.id }})">
                    {% if promo.is_active %}‚è∏{% else %}‚ñ∂{% endif %}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePromo({{ promo.id }})">üóë</button>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6" class="text-center">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal-bg" id="promoModalBg">
    <div class="modal">
        <button class="modal-close" onclick="closePromoModal()">√ó</button>
        <h3 id="promoModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
        <form id="promoForm" method="post">
            <input type="hidden" name="id" id="promoId">
            <div class="form-group">
                <label>–ö–æ–¥:</label>
                <input type="text" name="code" id="promoCode" required class="form-input" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>–¢–∏–ø —Å–∫–∏–¥–∫–∏:</label>
                <select name="discount_type" id="promoDiscountType" class="form-select">
                    <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç (%)</option>
                    <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è (‚ÇΩ)</option>
                    <option value="days">–ë–æ–Ω—É—Å–Ω—ã–µ –¥–Ω–∏</option>
                </select>
            </div>
            <div class="form-group">
                <label>–ó–Ω–∞—á–µ–Ω–∏–µ:</label>
                <input type="number" name="discount_value" id="promoDiscountValue" required min="1" class="form-input">
            </div>
            <div class="form-group">
                <label>–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞):</label>
                <input type="number" name="max_uses" id="promoMaxUses" value="0" min="0" class="form-input">
            </div>
            <div class="form-group" id="validDaysGroup">
                <label>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–Ω–µ–π (0 = –±–µ—Å—Å—Ä–æ—á–Ω–æ):</label>
                <input type="number" name="valid_days" id="promoValidDays" value="0" min="0" class="form-input">
            </div>
            <div class="form-group" id="isActiveGroup" style="display: none;">
                <label>
                    <input type="checkbox" name="is_active" id="promoIsActive" checked> –ê–∫—Ç–∏–≤–µ–Ω
                </label>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.table {
    width: 100%;
    border-collapse: collapse;
    background: #1e1e1e;
    border-radius: 8px;
    overflow: hidden;
}
.table th, .table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #333;
}
.table th {
    background: #2a2a2a;
}
code {
    background: #2a2a2a;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}
.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
}
.badge-success { background: #28a745; color: #fff; }
.badge-secondary { background: #6c757d; color: #fff; }
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.btn-primary { background: #4a90d9; color: #fff; }
.btn-sm { padding: 4px 8px; font-size: 0.85em; }
.btn-info { background: #17a2b8; color: #fff; }
.btn-warning { background: #ffc107; color: #000; }
.btn-danger { background: #dc3545; color: #fff; }
.text-center { text-align: center; }
.modal-bg {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal {
    background: #1e1e1e;
    padding: 25px;
    border-radius: 10px;
    min-width: 350px;
    max-width: 450px;
    position: relative;
}
.modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5em;
    color: #888;
    cursor: pointer;
}
.modal h3 {
    margin: 0 0 20px 0;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #888;
    font-size: 0.9em;
}
.form-input, .form-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #2a2a2a;
    color: #fff;
}
</style>

<script>
let editingId = null;

function openPromoModal(id, code, discountType, discountValue, maxUses, isActive) {
    editingId = id || null;
    document.getElementById('promoModalBg').style.display = 'flex';
    document.getElementById('promoModalTitle').textContent = id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
    document.getElementById('promoForm').action = id ? `/admin/promo/${id}/edit` : '/admin/promo/new';
    document.getElementById('promoId').value = id || '';
    document.getElementById('promoCode').value = code || '';
    document.getElementById('promoDiscountType').value = discountType || 'percent';
    document.getElementById('promoDiscountValue').value = discountValue || '';
    document.getElementById('promoMaxUses').value = maxUses || 0;
    document.getElementById('promoIsActive').checked = isActive !== false;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è
    document.getElementById('validDaysGroup').style.display = id ? 'none' : 'block';
    document.getElementById('isActiveGroup').style.display = id ? 'block' : 'none';
}

function closePromoModal() {
    document.getElementById('promoModalBg').style.display = 'none';
}

document.getElementById('promoModalBg').onclick = function(e) {
    if (e.target === this) closePromoModal();
};

document.getElementById('promoForm').onsubmit = function(e) {
    e.preventDefault();
    const form = this;
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {'x-requested-with': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
    });
};

function togglePromo(id) {
    fetch(`/admin/promo/${id}/toggle`, {
        method: 'POST',
        headers: {'x-requested-with': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
    });
}

function deletePromo(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?')) return;
    fetch(`/admin/promo/${id}/delete`, {
        method: 'POST',
        headers: {'x-requested-with': 'XMLHttpRequest'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
    });
}
</script>
{% endblock %}
