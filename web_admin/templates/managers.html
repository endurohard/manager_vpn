{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h1>
    <button class="btn btn-primary" onclick="showAddModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<div class="card">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ò–º—è</th>
                <th>–ö–ª—é—á–µ–π</th>
                <th>–°–µ–≥–æ–¥–Ω—è</th>
                <th>–í—ã—Ä—É—á–∫–∞</th>
                <th>–î–æ–ª–≥</th>
                <th>–ü—Ä–∏–±—ã–ª—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for m in managers %}
            <tr data-id="{{ m.user_id }}">
                <td>
                    <a href="{{ request.app.root_path }}/managers/{{ m.user_id }}" class="link">
                        {{ m.user_id }}
                    </a>
                </td>
                <td>
                    <span class="manager-name">{{ m.custom_name or m.full_name or m.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</span>
                    {% if m.username %}
                    <small class="text-muted">@{{ m.username }}</small>
                    {% endif %}
                </td>
                <td>{{ m.keys_count }}</td>
                <td>{{ m.keys_today }}</td>
                <td>{{ '{:,.0f}'.format(m.total_revenue) }} ‚ÇΩ</td>
                <td style="color: #e74c3c;">{{ '{:,.0f}'.format(m.total_debt) }} ‚ÇΩ</td>
                <td style="color: {% if m.manager_profit >= 0 %}#27ae60{% else %}#e74c3c{% endif %};">{{ '{:,.0f}'.format(m.manager_profit) }} ‚ÇΩ</td>
                <td>
                    <span class="badge {% if m.is_active %}badge-success{% else %}badge-danger{% endif %}">
                        {{ '–ê–∫—Ç–∏–≤–µ–Ω' if m.is_active else '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' }}
                    </span>
                </td>
                <td class="actions">
                    <button class="btn btn-sm btn-icon" onclick="toggleManager({{ m.user_id }})" title="{{ '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' if m.is_active else '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' }}">
                        {% if m.is_active %}üîí{% else %}üîì{% endif %}
                    </button>
                    <button class="btn btn-sm btn-icon" onclick="showRenameModal({{ m.user_id }}, '{{ m.custom_name or '' }}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-sm btn-icon btn-danger" onclick="deleteManager({{ m.user_id }})" title="–£–¥–∞–ª–∏—Ç—å">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="text-center text-muted">–ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal: –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ -->
<div id="addModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
            <button class="modal-close" onclick="closeModal('addModal')">&times;</button>
        </div>
        <form id="addForm" onsubmit="addManager(event)">
            <div class="form-group">
                <label>Telegram ID</label>
                <input type="number" name="user_id" required placeholder="123456789">
            </div>
            <div class="form-group">
                <label>–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" name="custom_name" placeholder="–ò–≤–∞–Ω">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addModal')">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å -->
<div id="renameModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
            <button class="modal-close" onclick="closeModal('renameModal')">&times;</button>
        </div>
        <form id="renameForm" onsubmit="renameManager(event)">
            <input type="hidden" name="user_id" id="rename_user_id">
            <div class="form-group">
                <label>–ù–æ–≤–æ–µ –∏–º—è</label>
                <input type="text" name="custom_name" id="rename_name" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('renameModal')">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ROOT = '{{ request.app.root_path }}';

function showAddModal() {
    document.getElementById('addModal').style.display = 'flex';
}

function showRenameModal(userId, currentName) {
    document.getElementById('rename_user_id').value = userId;
    document.getElementById('rename_name').value = currentName;
    document.getElementById('renameModal').style.display = 'flex';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

async function addManager(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const resp = await fetch(ROOT + '/managers/add', {
        method: 'POST',
        body: formData
    });
    const data = await resp.json();

    if (data.success) {
        location.reload();
    } else {
        alert(data.error || '–û—à–∏–±–∫–∞');
    }
}

async function toggleManager(userId) {
    const resp = await fetch(ROOT + '/managers/' + userId + '/toggle', {
        method: 'POST'
    });
    const data = await resp.json();
    if (data.success) {
        location.reload();
    }
}

async function renameManager(e) {
    e.preventDefault();
    const form = e.target;
    const userId = document.getElementById('rename_user_id').value;
    const formData = new FormData(form);

    const resp = await fetch(ROOT + '/managers/' + userId + '/rename', {
        method: 'POST',
        body: formData
    });
    const data = await resp.json();
    if (data.success) {
        location.reload();
    }
}

async function deleteManager(userId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞? –≠—Ç–æ –Ω–µ —É–¥–∞–ª–∏—Ç –µ–≥–æ –∫–ª—é—á–∏.')) return;

    const resp = await fetch(ROOT + '/managers/' + userId, {
        method: 'DELETE'
    });
    const data = await resp.json();
    if (data.success) {
        location.reload();
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
document.querySelectorAll('.modal').forEach(modal => {
    modal.onclick = function(e) {
        if (e.target === modal) closeModal(modal.id);
    };
});
</script>
{% endblock %}
