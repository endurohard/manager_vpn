{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <div>
        <a href="{{ request.app.root_path }}/keys" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <h2>–ö–ª—é—á #{{ key.id }}</h2>
    </div>
    <div class="header-actions">
        {% if key.status == 'active' %}
        <span class="badge badge-success">{{ key.days_left }}</span>
        {% elif key.status == 'expired' %}
        <span class="badge badge-danger">{{ key.days_left }}</span>
        {% else %}
        <span class="badge badge-secondary">{{ key.days_left }}</span>
        {% endif %}
    </div>
</div>

<div class="detail-grid">
    <div class="card">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ</h3>
        <table class="info-table">
            <tr>
                <td>Email –∫–ª–∏–µ–Ω—Ç–∞:</td>
                <td><strong>{{ key.client_email or '-' }}</strong></td>
            </tr>
            <tr>
                <td>–¢–µ–ª–µ—Ñ–æ–Ω:</td>
                <td>{{ key.phone_number or '-' }}</td>
            </tr>
            <tr>
                <td>UUID:</td>
                <td><code class="uuid-full">{{ key.client_id }}</code></td>
            </tr>
            <tr>
                <td>–ü–µ—Ä–∏–æ–¥:</td>
                <td>{{ key.period or '-' }} ({{ key.expire_days or '?' }} –¥–Ω.)</td>
            </tr>
            <tr>
                <td>–°–æ–∑–¥–∞–Ω:</td>
                <td>{{ key.created_at }}</td>
            </tr>
            <tr>
                <td>–ú–µ–Ω–µ–¥–∂–µ—Ä:</td>
                <td>{{ key.manager_display }}</td>
            </tr>
            <tr>
                <td>–¶–µ–Ω–∞:</td>
                <td>{{ key.price or 0 }} ‚ÇΩ</td>
            </tr>
        </table>

        <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –∫–ª—é—á–æ–º -->
        <div class="key-actions">
            <button type="button" class="btn btn-success" onclick="showExtendModal()">
                –ü—Ä–æ–¥–ª–∏—Ç—å
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- –°–µ–∫—Ü–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π -->
<div class="card linked-section">
    <div class="linked-header">
        <h3>üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏</h3>
        {% if not is_linked_to %}
        <button type="button" class="btn btn-primary btn-sm" onclick="showLinkModal()">
            + –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–ª—é—á
        </button>
        {% endif %}
    </div>

    {% if is_linked_to %}
    <div class="linked-notice warning">
        <span class="notice-icon">‚ö†Ô∏è</span>
        <div class="notice-text">
            –≠—Ç–æ—Ç –∫–ª—é—á –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≥–ª–∞–≤–Ω–æ–º—É –∫–ª—é—á—É
            {% if master_key_info %}
            <a href="{{ request.app.root_path }}/keys/{{ master_key_info.id }}">
                {{ master_key_info.client_email or master_key_info.phone_number or is_linked_to[:8] }}...
            </a>
            {% else %}
            <code>{{ is_linked_to[:8] }}...</code>
            {% endif %}
            –∏ –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π.
        </div>
    </div>
    {% else %}
        {% if linked_keys %}
        <p class="hint">–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ URL —ç—Ç–æ–≥–æ –∫–ª—é—á–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫–ª—é—á–∏ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
        <div class="linked-list">
            {% for lk in linked_keys %}
            <div class="linked-item" data-link-id="{{ lk.link_id }}">
                <div class="linked-info">
                    <div class="linked-main">
                        {% if lk.key_id %}
                        <a href="{{ request.app.root_path }}/keys/{{ lk.key_id }}">
                            {{ lk.client_email or lk.phone_number or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}
                        </a>
                        {% else %}
                        <span class="uuid-only">{{ lk.linked_uuid[:8] }}...</span>
                        <span class="badge badge-warning">–ù–µ –≤ –ë–î</span>
                        {% endif %}
                    </div>
                    <div class="linked-meta">
                        <span class="uuid"><code>{{ lk.linked_uuid[:12] }}...</code></span>
                        <span class="linked-date">–ü—Ä–∏–≤—è–∑–∞–Ω: {{ lk.linked_at[:10] if lk.linked_at else '-' }}</span>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-xs" onclick="unlinkKey({{ lk.link_id }})">
                    –û—Ç–≤—è–∑–∞—Ç—å
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-linked">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π. –ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–ª—é—á–∏, —á—Ç–æ–±—ã –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏—Ö –≤ –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É.</p>
        {% endif %}
    {% endif %}
</div>

<div class="card vless-section">
    <h3>VLESS –∫–ª—é—á–∏</h3>
    <p class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª—é—á –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</p>

    {% if vless_keys %}
    <div class="vless-list">
        {% for vk in vless_keys %}
        <div class="vless-item">
            <div class="vless-header">
                <span class="server-name">{{ vk.server }}</span>
                <span class="inbound-name">{{ vk.inbound }}</span>
            </div>
            <div class="vless-url" onclick="copyToClipboard(this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
                <code>{{ vk.url }}</code>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-keys">VLESS –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è -->
<div id="extendModal" class="modal">
    <div class="modal-content">
        <h3>–ü—Ä–æ–¥–ª–∏—Ç—å –∫–ª—é—á</h3>
        <form id="extendForm">
            <div class="period-options">
                {% for key_name, period in prices.items() %}
                <label class="period-option">
                    <input type="radio" name="period" value="{{ key_name }}"
                           {% if key_name == '1_month' %}checked{% endif %}>
                    <div class="period-box">
                        <div class="period-name">{{ period.name }}</div>
                        <div class="period-price">+{{ period.price }} ‚ÇΩ</div>
                    </div>
                </label>
                {% endfor %}
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-success">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–ª—é—á–∞ -->
<div id="linkModal" class="modal">
    <div class="modal-content modal-wide">
        <h3>üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–ª—é—á</h3>
        <p class="modal-hint">–ù–∞–π–¥–∏—Ç–µ –∫–ª—é—á –ø–æ email, —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ UUID</p>

        <div class="search-input-wrap">
            <input type="text" id="linkSearchInput" placeholder="–ü–æ–∏—Å–∫..."
                   oninput="searchKeysForLink(this.value)" autocomplete="off">
            <div id="linkSearchSpinner" class="spinner" style="display:none;"></div>
        </div>

        <div id="linkSearchResults" class="search-results">
            <p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</p>
        </div>

        <div class="modal-divider">
            <span>–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ UUID –Ω–∞–ø—Ä—è–º—É—é</span>
        </div>

        <form id="linkForm" onsubmit="submitLinkForm(event)">
            <div class="form-group">
                <label for="linkedUuidInput">UUID –∫–ª—é—á–∞:</label>
                <input type="text" id="linkedUuidInput" name="linked_uuid"
                       placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                       pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeLinkModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div id="toast" class="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.back-link {
    color: var(--primary);
    text-decoration: none;
    display: block;
    margin-bottom: 5px;
}
.back-link:hover {
    text-decoration: underline;
}
.header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.badge {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
}
.badge-success { background: #28a745; color: #fff; }
.badge-danger { background: #dc3545; color: #fff; }
.badge-secondary { background: #6c757d; color: #fff; }
.detail-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 20px;
}
.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
}
.card h3 {
    margin: 0 0 15px 0;
    color: var(--text);
}
.info-table {
    width: 100%;
}
.info-table tr {
    border-bottom: 1px solid var(--border);
}
.info-table td {
    padding: 10px 0;
}
.info-table td:first-child {
    color: var(--text-muted);
    width: 150px;
}
.uuid-full {
    background: rgba(0,0,0,0.2);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    word-break: break-all;
}
.key-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}
.vless-section {
    margin-top: 20px;
}
.hint {
    color: var(--text-muted);
    font-size: 0.85em;
    margin-bottom: 15px;
}
.vless-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.vless-item {
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    overflow: hidden;
}
.vless-header {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(0,0,0,0.2);
}
.server-name {
    font-weight: 600;
    color: var(--primary);
}
.inbound-name {
    color: var(--text-muted);
    font-size: 0.9em;
}
.vless-url {
    padding: 12px 15px;
    cursor: pointer;
    transition: background 0.2s;
}
.vless-url:hover {
    background: rgba(255,255,255,0.05);
}
.vless-url code {
    word-break: break-all;
    font-size: 0.8em;
    color: var(--text-muted);
    display: block;
}
.no-keys {
    color: var(--text-muted);
    text-align: center;
    padding: 20px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}
.modal.show {
    display: flex;
}
.modal-content {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
}
.modal-content h3 {
    margin: 0 0 1rem 0;
}
.period-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}
.period-option input {
    display: none;
}
.period-box {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.period-option input:checked + .period-box {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}
.period-name {
    font-weight: 500;
}
.period-price {
    color: #22c55e;
    font-weight: 600;
}
.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: #fff;
    padding: 12px 24px;
    border-radius: 6px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 1001;
}
.toast.show {
    opacity: 1;
}

/* Linked keys section */
.linked-section {
    margin-top: 20px;
}
.linked-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.linked-header h3 {
    margin: 0;
}
.btn-sm {
    padding: 6px 12px;
    font-size: 0.85em;
}
.btn-xs {
    padding: 4px 8px;
    font-size: 0.8em;
}
.linked-notice {
    display: flex;
    gap: 10px;
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.linked-notice.warning {
    background: rgba(255, 193, 7, 0.15);
    border: 1px solid rgba(255, 193, 7, 0.3);
}
.notice-icon {
    font-size: 1.2em;
}
.notice-text {
    color: var(--text);
    line-height: 1.5;
}
.notice-text a {
    color: var(--primary);
    text-decoration: none;
}
.notice-text a:hover {
    text-decoration: underline;
}
.linked-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.linked-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
}
.linked-info {
    flex: 1;
}
.linked-main {
    font-weight: 500;
    margin-bottom: 4px;
}
.linked-main a {
    color: var(--primary);
    text-decoration: none;
}
.linked-main a:hover {
    text-decoration: underline;
}
.uuid-only {
    color: var(--text-muted);
}
.linked-meta {
    display: flex;
    gap: 15px;
    font-size: 0.85em;
    color: var(--text-muted);
}
.linked-meta .uuid code {
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
}
.no-linked {
    color: var(--text-muted);
    text-align: center;
    padding: 20px;
    font-style: italic;
}
.badge-warning {
    background: #ffc107;
    color: #212529;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75em;
    margin-left: 8px;
}

/* Link modal */
.modal-wide {
    max-width: 500px;
}
.modal-hint {
    color: var(--text-muted);
    margin-bottom: 15px;
    font-size: 0.9em;
}
.search-input-wrap {
    position: relative;
    margin-bottom: 15px;
}
.search-input-wrap input {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: rgba(0,0,0,0.2);
    color: var(--text);
    font-size: 1em;
}
.search-input-wrap input:focus {
    outline: none;
    border-color: var(--primary);
}
.spinner {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    to { transform: translateY(-50%) rotate(360deg); }
}
.search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 15px;
}
.search-hint {
    color: var(--text-muted);
    font-size: 0.9em;
    text-align: center;
    padding: 15px;
}
.search-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.2s;
}
.search-result-item:hover {
    background: rgba(0,0,0,0.3);
}
.search-result-info {
    flex: 1;
}
.search-result-name {
    font-weight: 500;
    margin-bottom: 2px;
}
.search-result-uuid {
    font-size: 0.8em;
    color: var(--text-muted);
}
.modal-divider {
    text-align: center;
    margin: 20px 0;
    position: relative;
}
.modal-divider::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    height: 1px;
    background: var(--border);
}
.modal-divider span {
    background: var(--card-bg);
    padding: 0 15px;
    position: relative;
    color: var(--text-muted);
    font-size: 0.85em;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-muted);
    font-size: 0.9em;
}
.form-group input {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--border);
    border-radius: 6px;
    background: rgba(0,0,0,0.2);
    color: var(--text);
    font-family: monospace;
}
.form-group input:focus {
    outline: none;
    border-color: var(--primary);
}
</style>
{% endblock %}

{% block scripts %}
<script>
const ROOT = '{{ request.app.root_path }}';
const KEY_ID = {{ key.id }};

function copyToClipboard(element) {
    const text = element.querySelector('code').textContent;
    navigator.clipboard.writeText(text).then(() => {
        showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
    });
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

function showExtendModal() {
    document.getElementById('extendModal').classList.add('show');
}

function closeModal() {
    document.getElementById('extendModal').classList.remove('show');
}

document.getElementById('extendForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    try {
        const resp = await fetch(ROOT + '/keys/' + KEY_ID + '/extend', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();

        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }

    closeModal();
});

async function confirmDelete() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤?')) {
        return;
    }

    try {
        const resp = await fetch(ROOT + '/keys/' + KEY_ID, {
            method: 'DELETE'
        });
        const data = await resp.json();

        if (data.success) {
            alert(data.message);
            location.href = ROOT + '/keys';
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
document.getElementById('extendModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// ============ Linked keys functions ============

let searchTimeout = null;

function showLinkModal() {
    document.getElementById('linkModal').classList.add('show');
    document.getElementById('linkSearchInput').focus();
}

function closeLinkModal() {
    document.getElementById('linkModal').classList.remove('show');
    document.getElementById('linkSearchInput').value = '';
    document.getElementById('linkedUuidInput').value = '';
    document.getElementById('linkSearchResults').innerHTML = '<p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</p>';
}

function searchKeysForLink(query) {
    clearTimeout(searchTimeout);

    const resultsDiv = document.getElementById('linkSearchResults');
    const spinner = document.getElementById('linkSearchSpinner');

    if (query.length < 3) {
        resultsDiv.innerHTML = '<p class="search-hint">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</p>';
        return;
    }

    spinner.style.display = 'block';

    searchTimeout = setTimeout(async () => {
        try {
            const resp = await fetch(ROOT + '/keys/search/uuid?q=' + encodeURIComponent(query) + '&exclude_id=' + KEY_ID);
            const data = await resp.json();

            if (data.results && data.results.length > 0) {
                let html = '';
                for (const key of data.results) {
                    const name = key.client_email || key.phone_number || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                    const uuid = key.client_id;
                    html += `
                        <div class="search-result-item" onclick="selectKeyForLink('${uuid}', ${key.id})">
                            <div class="search-result-info">
                                <div class="search-result-name">${escapeHtml(name)}</div>
                                <div class="search-result-uuid">${uuid.substring(0, 12)}...</div>
                            </div>
                            <span class="btn btn-primary btn-xs">–í—ã–±—Ä–∞—Ç—å</span>
                        </div>
                    `;
                }
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<p class="search-hint">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            }
        } catch (e) {
            resultsDiv.innerHTML = '<p class="search-hint">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</p>';
        } finally {
            spinner.style.display = 'none';
        }
    }, 300);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function selectKeyForLink(uuid, keyId) {
    linkKeyById(keyId);
}

async function linkKeyById(linkedKeyId) {
    const formData = new FormData();
    formData.append('linked_key_id', linkedKeyId);

    try {
        const resp = await fetch(ROOT + '/keys/' + KEY_ID + '/link', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();

        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }

    closeLinkModal();
}

async function submitLinkForm(e) {
    e.preventDefault();
    const uuid = document.getElementById('linkedUuidInput').value.trim();

    if (!uuid) {
        alert('–í–≤–µ–¥–∏—Ç–µ UUID –∫–ª—é—á–∞');
        return;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è UUID —Ñ–æ—Ä–º–∞—Ç–∞
    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidPattern.test(uuid)) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç UUID');
        return;
    }

    const formData = new FormData();
    formData.append('linked_uuid', uuid);

    try {
        const resp = await fetch(ROOT + '/keys/' + KEY_ID + '/link', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();

        if (data.success) {
            showToast(data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }

    closeLinkModal();
}

async function unlinkKey(linkId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á?')) {
        return;
    }

    try {
        const resp = await fetch(ROOT + '/keys/' + KEY_ID + '/unlink/' + linkId, {
            method: 'DELETE'
        });
        const data = await resp.json();

        if (data.success) {
            showToast(data.message);
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
            const item = document.querySelector(`.linked-item[data-link-id="${linkId}"]`);
            if (item) {
                item.remove();
            }
            // –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const linkedList = document.querySelector('.linked-list');
            if (linkedList && linkedList.children.length === 0) {
                linkedList.innerHTML = '<p class="no-linked">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π. –ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–ª—é—á–∏, —á—Ç–æ–±—ã –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏—Ö –≤ –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É.</p>';
            }
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ link –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
document.getElementById('linkModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLinkModal();
    }
});
</script>
{% endblock %}
