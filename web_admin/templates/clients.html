{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <h2>Клиенты</h2>
    <span class="total-count">Найдено: {{ total }}</span>
</div>

<div class="filters-row">
    <form method="get" class="search-form">
        <input type="text" name="search" value="{{ search }}" placeholder="Поиск по email, телефону, client_id..." class="search-input">
        <select name="manager_id" class="filter-select">
            <option value="">Все менеджеры</option>
            {% for m in managers %}
            <option value="{{ m.user_id }}" {% if manager_id == m.user_id %}selected{% endif %}>{{ m.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Найти</button>
        {% if search or manager_id %}
        <a href="/manager/clients" class="btn btn-secondary">Сбросить</a>
        {% endif %}
    </form>
</div>

<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Email / Телефон</th>
                <th>Ключей</th>
                <th>Потрачено</th>
                <th>Последний ключ</th>
                <th>Менеджер</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr>
                <td>
                    <div class="client-info">
                        {% if client.client_email %}
                        <strong>{{ client.client_email }}</strong>
                        {% endif %}
                        {% if client.phone_number %}
                        <br><small class="text-muted">{{ client.phone_number }}</small>
                        {% endif %}
                    </div>
                </td>
                <td>{{ client.keys_count }}</td>
                <td>{{ client.total_spent }}₽</td>
                <td>{{ client.last_key_date[:10] if client.last_key_date else '-' }}</td>
                <td>{{ client.last_manager or '-' }}</td>
                <td>
                    <a href="/manager/clients/{{ client.client_email or client.phone_number }}" class="btn btn-sm btn-info" title="Подробнее">Подробнее</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center">
                    {% if search or manager_id %}
                    Клиенты не найдены. <a href="/manager/clients">Сбросить фильтры</a>
                    {% else %}
                    Нет клиентов
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if manager_id %}&manager_id={{ manager_id }}{% endif %}" class="page-link">← Назад</a>
    {% endif %}

    {% for p in pages %}
        {% if p == '...' %}
        <span class="page-ellipsis">...</span>
        {% elif p == page %}
        <span class="page-link active">{{ p }}</span>
        {% else %}
        <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if manager_id %}&manager_id={{ manager_id }}{% endif %}" class="page-link">{{ p }}</a>
        {% endif %}
    {% endfor %}

    {% if page < total_pages %}
    <a href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if manager_id %}&manager_id={{ manager_id }}{% endif %}" class="page-link">Вперёд →</a>
    {% endif %}
</div>
{% endif %}

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.total-count {
    color: #888;
    font-size: 0.9em;
}
.filters-row {
    margin-bottom: 20px;
}
.search-form {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.search-input {
    flex: 1;
    min-width: 200px;
    padding: 8px 12px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #2a2a2a;
    color: #fff;
}
.filter-select {
    padding: 8px 12px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #2a2a2a;
    color: #fff;
    min-width: 150px;
}
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}
.btn-primary {
    background: #4a90d9;
    color: #fff;
}
.btn-secondary {
    background: #555;
    color: #fff;
}
.btn-sm {
    padding: 4px 8px;
    font-size: 0.85em;
}
.btn-info {
    background: #17a2b8;
    color: #fff;
}
.table-responsive {
    overflow-x: auto;
}
.table {
    width: 100%;
    border-collapse: collapse;
}
.table th, .table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #333;
}
.table th {
    background: #2a2a2a;
    font-weight: 600;
}
.table tbody tr:hover {
    background: #2a2a2a;
}
.client-info {
    line-height: 1.4;
}
.text-muted {
    color: #888;
}
.text-center {
    text-align: center;
}
.pagination {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-top: 20px;
}
.page-link {
    padding: 8px 12px;
    background: #2a2a2a;
    color: #fff;
    text-decoration: none;
    border-radius: 4px;
}
.page-link:hover {
    background: #3a3a3a;
}
.page-link.active {
    background: #4a90d9;
}
.page-ellipsis {
    padding: 8px 12px;
    color: #888;
}
</style>
{% endblock %}
