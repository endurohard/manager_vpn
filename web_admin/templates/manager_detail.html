{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="breadcrumb">
        <a href="{{ request.app.root_path }}/managers">Менеджеры</a>
        <span>/</span>
        <span>{{ manager.custom_name or manager.full_name or manager.username or 'ID: ' ~ manager.user_id }}</span>
    </div>
</div>

<div class="manager-profile">
    <div class="profile-header">
        <div class="profile-avatar">
            {{ (manager.custom_name or manager.full_name or 'M')[0] | upper }}
        </div>
        <div class="profile-info">
            <h1>{{ manager.custom_name or manager.full_name or 'Без имени' }}</h1>
            <div class="profile-meta">
                <span class="meta-item">ID: {{ manager.user_id }}</span>
                {% if manager.username %}
                <span class="meta-item">@{{ manager.username }}</span>
                {% endif %}
                <span class="badge {% if manager.is_active %}badge-success{% else %}badge-danger{% endif %}">
                    {{ 'Активен' if manager.is_active else 'Заблокирован' }}
                </span>
            </div>
            <div class="profile-date">
                Добавлен: {{ manager.added_at[:10] if manager.added_at else 'N/A' }}
            </div>
        </div>
    </div>
</div>

<!-- Статистика -->
<div class="stats-cards">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_keys }}</div>
        <div class="stat-label">Всего ключей</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.today }}</div>
        <div class="stat-label">Сегодня</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.week }}</div>
        <div class="stat-label">За неделю</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.month }}</div>
        <div class="stat-label">За месяц</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ '{:,.0f}'.format(stats.total_revenue) }} ₽</div>
        <div class="stat-label">Выручка</div>
    </div>
    <div class="stat-card stat-debt">
        <div class="stat-value">{{ '{:,.0f}'.format(debt_total) }} ₽</div>
        <div class="stat-label">Должен мне</div>
    </div>
    <div class="stat-card {% if manager_profit >= 0 %}stat-profit{% else %}stat-debt{% endif %}">
        <div class="stat-value">{{ '{:,.0f}'.format(manager_profit) }} ₽</div>
        <div class="stat-label">Прибыль</div>
    </div>
</div>

<div class="content-grid">
    <!-- Себестоимости -->
    <div class="card">
        <h3>Себестоимости</h3>
        <form id="costPricesForm" class="cost-prices-form">
            {% for mp in manager_prices_display %}
            <div class="form-group cost-row">
                <label>{{ mp.name }} ({{ mp.days }} дн.)</label>
                <input type="number" name="cost_{{ mp.days }}" data-days="{{ mp.days }}"
                       value="{{ mp.cost_price }}" placeholder="{{ mp.global_price }}" min="0" class="cost-input">
                <small class="text-muted">Глобальная: {{ mp.global_price }} ₽</small>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary btn-sm" style="margin-top: 0.5rem; width: 100%;">Сохранить</button>
        </form>
    </div>

    <!-- Статистика по периодам -->
    <div class="card">
        <h3>По тарифам</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Период</th>
                    <th>Ключей</th>
                    <th>Выручка</th>
                    <th>Себест.</th>
                    <th>Долг</th>
                </tr>
            </thead>
            <tbody>
                {% for p in periods_stats %}
                <tr>
                    <td>{{ p.period }}</td>
                    <td>{{ p.count }}</td>
                    <td>{{ '{:,.0f}'.format(p.revenue) }} ₽</td>
                    <td>{{ '{:,.0f}'.format(p.cost_price) }} ₽</td>
                    <td>{{ '{:,.0f}'.format(p.debt) }} ₽</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">Нет данных</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Последние ключи -->
    <div class="card wide">
        <h3>Последние ключи</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Клиент</th>
                    <th>Период</th>
                    <th>Цена</th>
                    <th>Дата</th>
                </tr>
            </thead>
            <tbody>
                {% for key in recent_keys %}
                <tr>
                    <td>
                        <a href="{{ request.app.root_path }}/keys/{{ key.id }}" class="link">
                            {{ key.client_email or key.phone_number or key.client_id[:8] ~ '...' }}
                        </a>
                    </td>
                    <td>{{ key.period }}</td>
                    <td>{{ key.price or 0 }} ₽</td>
                    <td>{{ key.created_at[:16] if key.created_at else 'N/A' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted">Нет ключей</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.manager-profile {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 600;
    color: white;
}

.profile-info h1 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
}

.profile-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.meta-item {
    color: var(--text-muted);
    font-family: monospace;
}

.profile-date {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.stats-cards {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    text-align: center;
    flex: 1;
    min-width: 120px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.85rem;
}

.stat-debt .stat-value {
    color: #e74c3c;
}

.stat-profit .stat-value {
    color: #27ae60;
}

.cost-prices-form .cost-row {
    margin-bottom: 0.75rem;
}

.cost-prices-form label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 500;
    font-size: 0.9rem;
}

.cost-input {
    width: 100%;
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
}

.cost-input:focus {
    outline: none;
    border-color: var(--primary);
}

.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 2fr;
    gap: 1rem;
}

.content-grid .wide {
    grid-column: span 1;
}

@media (max-width: 1100px) {
    .content-grid {
        grid-template-columns: 1fr 1fr;
    }
}

@media (max-width: 700px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
}

.breadcrumb a {
    color: var(--primary);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const ROOT = '{{ request.app.root_path }}';
const MANAGER_ID = {{ manager.user_id }};

document.getElementById('costPricesForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const inputs = this.querySelectorAll('.cost-input');
    const prices = [];
    inputs.forEach(input => {
        const val = input.value.trim();
        if (val !== '') {
            prices.push({
                expire_days: parseInt(input.dataset.days),
                cost_price: parseInt(val)
            });
        }
    });

    const resp = await fetch(ROOT + '/managers/' + MANAGER_ID + '/prices', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({prices: prices})
    });
    const data = await resp.json();
    if (data.success) {
        location.reload();
    } else {
        alert(data.error || 'Ошибка сохранения');
    }
});
</script>
{% endblock %}
